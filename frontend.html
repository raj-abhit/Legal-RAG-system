<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Legal Research Assistant | Indian Law Database</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0b50da",
                        "primary-hover": "#0a45bd",
                        "bg-dark": "#101622",
                        "surface": "#1e293b",
                        "sidebar": "#0d121c",
                    },
                    fontFamily: { "display": ["Public Sans", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        .dark ::-webkit-scrollbar { width: 6px; }
        .dark ::-webkit-scrollbar-track { background: transparent; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        .msg { animation: fadeIn .25s ease-out; }
        .chat-item:hover .chat-delete { opacity: 1; }
        .chat-delete { opacity: 0; transition: opacity .15s; }
        @keyframes pulse-ring { 0% { transform:scale(.8); opacity:1; } 100% { transform:scale(1.6); opacity:0; } }
        .mic-recording { position:relative; }
        .mic-recording::before { content:''; position:absolute; inset:-4px; border-radius:50%; background:rgba(239,68,68,.4); animation:pulse-ring 1.2s ease-out infinite; }
        .mic-recording .material-symbols-outlined { color:#ef4444 !important; }
    </style>
</head>
<body class="bg-bg-dark font-display text-slate-100 h-screen overflow-hidden flex">

<!-- ===== SIDEBAR ===== -->
<aside id="sidebar" class="w-72 bg-sidebar border-r border-slate-800 flex flex-col h-full shrink-0 hidden md:flex">
    <!-- New Chat button -->
    <div class="p-3 border-b border-slate-800">
        <button onclick="newChat()" class="w-full flex items-center gap-2 px-4 py-2.5 rounded-lg bg-primary hover:bg-primary-hover text-white text-sm font-medium transition-colors">
            <span class="material-symbols-outlined text-[18px]">add</span>
            New Chat
        </button>
    </div>

    <!-- Chat list -->
    <div class="flex-1 overflow-y-auto px-2 py-2" id="chat-list">
        <p class="text-slate-600 text-xs text-center py-8">No previous chats</p>
    </div>

    <!-- Footer -->
    <div class="p-3 border-t border-slate-800">
        <p class="text-slate-600 text-[10px] leading-relaxed text-center">
            AI-generated info — not legal advice. Consult a lawyer for specific matters.
        </p>
    </div>
</aside>

<!-- ===== MAIN ===== -->
<main class="flex-1 flex flex-col h-full min-w-0">
    <!-- Header -->
    <div class="h-14 flex items-center justify-between px-6 border-b border-slate-800/50 bg-bg-dark/80 backdrop-blur-sm shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
                <span class="material-symbols-outlined">menu</span>
            </button>
            <span class="material-symbols-outlined text-primary">gavel</span>
            <h2 class="text-slate-200 font-semibold text-base truncate" id="chat-title">Legal Research Assistant</h2>
            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-primary/20 text-primary border border-primary/30 uppercase">RAG</span>
            <span id="connection-status" class="px-2 py-0.5 rounded text-[10px] font-medium bg-green-500/20 text-green-400 border border-green-500/30">● Connected</span>
        </div>
    </div>

    <!-- Messages area -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 min-h-0">
        <!-- Welcome screen -->
        <div id="welcome-screen" class="flex flex-col items-center justify-center text-center max-w-2xl mx-auto h-full">
            <div class="mb-6 p-4 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 shadow-2xl border border-slate-700">
                <span class="material-symbols-outlined text-primary text-5xl">gavel</span>
            </div>
            <h1 class="text-white text-3xl font-bold mb-2">Indian Legal Research Assistant</h1>
            <p class="text-slate-400 text-sm mb-8 max-w-md leading-relaxed">
                AI-powered legal research across Constitution, BNS, BNSS, BSA, and landmark Supreme Court judgments.
            </p>
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="askQuestion('What are my rights if police arrest me?')" class="px-4 py-2 rounded-full bg-surface border border-slate-700 hover:border-primary/50 text-slate-300 text-sm transition-all">Rights on Arrest</button>
                <button onclick="askQuestion('What are the bail provisions under BNSS 2023?')" class="px-4 py-2 rounded-full bg-surface border border-slate-700 hover:border-primary/50 text-slate-300 text-sm transition-all">Bail Provisions</button>
                <button onclick="askQuestion('Draft a legal notice for cheque bounce')" class="px-4 py-2 rounded-full bg-surface border border-slate-700 hover:border-primary/50 text-slate-300 text-sm transition-all">Legal Notice</button>
                <button onclick="askQuestion('Explain Article 21 of the Constitution')" class="px-4 py-2 rounded-full bg-surface border border-slate-700 hover:border-primary/50 text-slate-300 text-sm transition-all">Fundamental Rights</button>
            </div>
        </div>

        <div id="messages" class="hidden flex-col gap-5 w-full max-w-4xl mx-auto"></div>
    </div>

    <!-- Input area -->
    <div class="px-4 pb-5 pt-2 shrink-0">
        <div class="max-w-4xl mx-auto">
            <div class="relative bg-surface rounded-2xl border border-slate-700 focus-within:ring-2 focus-within:ring-primary/50 focus-within:border-primary transition-all">
                <textarea id="question-input" class="w-full bg-transparent text-white placeholder-slate-500 text-sm p-4 min-h-[52px] max-h-[160px] resize-none focus:outline-none rounded-t-2xl" placeholder="Ask a legal question..." rows="1" onkeypress="handleKeyPress(event)" maxlength="2000"></textarea>
                <div class="flex items-center justify-between px-3 pb-3">
                    <span class="text-[11px] text-slate-600"><span id="char-count">0</span>/2000</span>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleVoiceInput()" id="mic-btn" title="Voice input" class="p-2 text-slate-400 hover:text-white rounded-xl transition-all active:scale-95">
                            <span class="material-symbols-outlined text-[18px]">mic</span>
                        </button>
                        <button onclick="sendQuestion()" id="send-btn" class="p-2 bg-primary hover:bg-primary-hover text-white rounded-xl transition-all active:scale-95">
                            <span class="material-symbols-outlined text-[18px]">send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
// ===== STATE =====
let currentChatId = null;

// ===== SIDEBAR: Load chat list =====
async function loadChatList() {
    try {
        const res = await fetch('/chats');
        const chats = await res.json();
        const list = document.getElementById('chat-list');
        if (!chats.length) {
            list.innerHTML = '<p class="text-slate-600 text-xs text-center py-8">No previous chats</p>';
            return;
        }
        list.innerHTML = chats.map(c => `
            <div class="chat-item group flex items-center gap-1 px-3 py-2.5 rounded-lg cursor-pointer transition-colors mb-0.5 ${c.id === currentChatId ? 'bg-slate-800' : 'hover:bg-slate-800/60'}" onclick="loadChat('${c.id}')">
                <span class="material-symbols-outlined text-slate-500 text-[16px] shrink-0">chat_bubble</span>
                <span class="flex-1 text-sm text-slate-300 truncate ml-1">${escapeHtml(c.title)}</span>
                <span class="text-[10px] text-slate-600 shrink-0">${c.message_count || 0}</span>
                <button onclick="event.stopPropagation(); deleteChat('${c.id}')" class="chat-delete ml-1 text-slate-600 hover:text-red-400 transition-colors" title="Delete">
                    <span class="material-symbols-outlined text-[16px]">close</span>
                </button>
            </div>
        `).join('');
    } catch(e) {
        console.error('Failed to load chats:', e);
    }
}

// ===== SIDEBAR: New chat =====
async function newChat() {
    currentChatId = null;
    document.getElementById('messages').innerHTML = '';
    document.getElementById('messages').classList.add('hidden');
    document.getElementById('welcome-screen').classList.remove('hidden');
    document.getElementById('welcome-screen').style.display = '';
    document.getElementById('chat-title').textContent = 'Legal Research Assistant';

    // Reset server-side conversation memory
    try { await fetch('/chats', { method: 'POST' }); } catch(e) {}
    loadChatList();
}

// ===== SIDEBAR: Load a previous chat =====
async function loadChat(chatId) {
    try {
        const res = await fetch('/chats/' + chatId);
        if (!res.ok) throw new Error('Chat not found');
        const data = await res.json();

        currentChatId = chatId;
        document.getElementById('chat-title').textContent = data.chat.title;

        // Render messages
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        document.getElementById('welcome-screen').style.display = 'none';
        messagesDiv.classList.remove('hidden');

        for (const msg of data.messages) {
            appendMessage(msg.question, true);
            appendMessage(msg.answer, false, !!msg.is_followup);
            try {
                const sources = JSON.parse(msg.sources || '[]');
                if (sources.length) {
                    const formatted = sources.map(s => s.document + ' (Page ' + s.page + ')');
                    appendSources(formatted);
                }
            } catch(e) {}
        }

        // Scroll to bottom
        const container = document.getElementById('chat-container');
        setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
        loadChatList();
    } catch(e) {
        console.error('Failed to load chat:', e);
    }
}

// ===== SIDEBAR: Delete a chat =====
async function deleteChat(chatId) {
    try {
        await fetch('/chats/' + chatId, { method: 'DELETE' });
        if (chatId === currentChatId) newChat();
        else loadChatList();
    } catch(e) {
        console.error('Failed to delete chat:', e);
    }
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('hidden');
}

// ===== MESSAGES =====
function appendMessage(text, isUser, hasContext) {
    const messagesDiv = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'msg flex gap-3 ' + (isUser ? 'justify-end' : '');
    if (isUser) {
        div.innerHTML = '<div class="max-w-[80%] bg-primary rounded-2xl px-4 py-3 shadow-lg"><p class="text-white text-sm leading-relaxed">' + escapeHtml(text) + '</p></div>';
    } else {
        const badge = hasContext ? '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] bg-blue-500/20 text-blue-400 border border-blue-500/30 mb-1"><span class="material-symbols-outlined" style="font-size:12px">history</span>Contextual</span>' : '';
        div.innerHTML = '<div class="size-7 rounded-full bg-gradient-to-br from-primary to-primary-hover flex items-center justify-center shrink-0 shadow"><span class="material-symbols-outlined text-white text-[14px]">gavel</span></div>' +
            '<div class="flex-1 max-w-[85%]">' + badge +
            '<div class="bg-surface rounded-2xl px-4 py-3 shadow border border-slate-700/60"><div class="text-slate-200 text-sm leading-relaxed whitespace-pre-wrap">' + text + '</div></div></div>';
    }
    messagesDiv.appendChild(div);
    div.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

function appendSources(sources) {
    const messagesDiv = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'msg flex gap-3 -mt-3';
    const list = sources.slice(0, 4).map(s => '<li class="text-slate-400 text-xs">' + escapeHtml(s) + '</li>').join('');
    div.innerHTML = '<div class="size-7 shrink-0"></div>' +
        '<details class="group"><summary class="cursor-pointer text-slate-500 text-xs flex items-center gap-1 hover:text-slate-400 transition-colors">' +
        '<span class="material-symbols-outlined" style="font-size:14px">folder_open</span>Sources (' + sources.length + ')' +
        '<span class="material-symbols-outlined group-open:rotate-180 transition-transform" style="font-size:14px">expand_more</span></summary>' +
        '<div class="mt-1 bg-slate-800/50 rounded-lg px-3 py-2 border border-slate-700/50"><ul class="list-decimal list-inside space-y-0.5">' + list + '</ul></div></details>';
    messagesDiv.appendChild(div);
}

function showThinking() {
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('messages').classList.remove('hidden');
    const div = document.createElement('div');
    div.id = 'thinking';
    div.className = 'msg flex gap-3';
    div.innerHTML = '<div class="size-7 rounded-full bg-gradient-to-br from-primary to-primary-hover flex items-center justify-center shrink-0 animate-pulse shadow"><span class="material-symbols-outlined text-white text-[14px]">search</span></div>' +
        '<div class="bg-surface rounded-2xl px-4 py-3 shadow border border-slate-700/60"><p class="text-slate-400 text-sm">Searching legal database...</p></div>';
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

function removeThinking() {
    const t = document.getElementById('thinking');
    if (t) t.remove();
}

// ===== SEND QUESTION =====
async function sendQuestion() {
    const input = document.getElementById('question-input');
    const question = input.value.trim();
    if (!question) return;

    appendMessage(question, true);
    input.value = '';
    document.getElementById('char-count').textContent = '0';
    showThinking();

    try {
        const res = await fetch('/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: question, chat_id: currentChatId })
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Request failed');
        }
        const data = await res.json();

        // Track chat — if server created a new one, update our state
        if (data.chat_id && data.chat_id !== currentChatId) {
            currentChatId = data.chat_id;
            document.getElementById('chat-title').textContent = question.slice(0, 50) + (question.length > 50 ? '...' : '');
        }

        removeThinking();
        appendMessage(data.answer, false, data.is_followup);

        if (data.sources && data.sources.length) {
            const formatted = data.sources.map(s => s.document + ' (Page ' + s.page + ')');
            appendSources(formatted);
        }

        loadChatList();

    } catch(e) {
        removeThinking();
        appendMessage('Error: ' + e.message, false);
    }
}

function askQuestion(q) {
    document.getElementById('question-input').value = q;
    sendQuestion();
}

function handleKeyPress(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendQuestion(); }
}

function escapeHtml(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

// ===== VOICE INPUT (Web Speech API) =====
let recognition = null;
let isRecording = false;

function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        document.getElementById('mic-btn').title = 'Voice input not supported in this browser';
        document.getElementById('mic-btn').classList.add('opacity-30', 'cursor-not-allowed');
        return;
    }
    recognition = new SpeechRecognition();
    recognition.lang = 'en-IN';
    recognition.interimResults = true;
    recognition.continuous = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
        isRecording = true;
        const btn = document.getElementById('mic-btn');
        btn.classList.add('mic-recording');
        document.getElementById('question-input').placeholder = 'Listening...';
    };

    recognition.onresult = (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        const input = document.getElementById('question-input');
        // If final result, set value; otherwise show interim
        if (event.results[event.results.length - 1].isFinal) {
            input.value = transcript;
        } else {
            input.value = transcript;
        }
        document.getElementById('char-count').textContent = input.value.length;
    };

    recognition.onend = () => {
        isRecording = false;
        const btn = document.getElementById('mic-btn');
        btn.classList.remove('mic-recording');
        document.getElementById('question-input').placeholder = 'Ask a legal question...';
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isRecording = false;
        const btn = document.getElementById('mic-btn');
        btn.classList.remove('mic-recording');
        document.getElementById('question-input').placeholder = 'Ask a legal question...';
        if (event.error === 'not-allowed') {
            alert('Microphone access denied. Please allow microphone permissions.');
        }
    };
}

function toggleVoiceInput() {
    if (!recognition) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { alert('Voice input is not supported in this browser. Use Chrome or Edge.'); return; }
        initSpeechRecognition();
    }
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
}

initSpeechRecognition();

// ===== HEALTH CHECK =====
async function checkHealth() {
    try {
        const res = await fetch('/health');
        const data = await res.json();
        const el = document.getElementById('connection-status');
        el.textContent = data.vectorstore_loaded ? '● Connected' : '● Initializing';
        el.className = 'px-2 py-0.5 rounded text-[10px] font-medium border ' +
            (data.vectorstore_loaded ? 'bg-green-500/20 text-green-400 border-green-500/30' : 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30');
    } catch(e) {
        const el = document.getElementById('connection-status');
        el.textContent = '● Offline';
        el.className = 'px-2 py-0.5 rounded text-[10px] font-medium bg-red-500/20 text-red-400 border border-red-500/30';
    }
}

// ===== INPUT COUNTER =====
document.getElementById('question-input').addEventListener('input', function(e) {
    document.getElementById('char-count').textContent = e.target.value.length;
});

// ===== INIT =====
loadChatList();
checkHealth();
setInterval(checkHealth, 30000);
</script>
</body>
</html>
